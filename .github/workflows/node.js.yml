name: CI Pipeline

on:
  push: # Trigger on all pushes to any branch
    branches: 
      - '**' # Match all branches
  pull_request: # Trigger on all pull requests to any branch
    branches: 
      - '**' # Match all branches

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - run: npm ci

      - name: Run Jest tests
        run: npm test

  detox-tests:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 1

    - name: Add avdmanager and sdkmanager to system PATH
      run: |
        echo "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}" >> $GITHUB_PATH

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: 17
        distribution: 'adopt'
        cache: 'gradle'

    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Install node_modules
      run: |
        npm install

    - name: Install Sdk
      run: |
        yes Y | sdkmanager --licenses
        Sdkmanager --install ${ANDROID_SDK_PACKAGES}

    - name: Start Emulator
      uses: ReactiveCircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: arm64-v8a
        profile: pixel_3a
        disable-animations: true
        script: adb wait-for-device
        
    - name: Set up Gradle
      uses: gradle/gradle-build-action@v2

    - name: Start Metro Bundler
      run: |
        npx react-native start &> metro.log &

    - name: Run Detox Tests
      run: |
        npx detox build -c android.emu.debug
        npx detox test -c android.emu.debug
